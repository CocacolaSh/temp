@{
    Layout = null;    
    int pageid = WebHelper.GetInt("page", 1);
    string path = Ocean.Framework.Configuration.global.config.GlobalConfig.GetConfig()["ResourceDomain"];
    
}
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>关键词回复</title>
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/MpMaterial/css/pagination.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/Mpreply/css/common.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/Mpreply/css/keyword.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/Mpreply/css/wxm.css")" />
    <script type="text/javascript" src="@Url.Content("~/Content/jquery-easyui-1.3.5/jquery-1.7.2.min.js")"></script> 
    <script type="text/javascript" src="@Url.Content("~/Content/jquery-easyui-1.3.5/plugins/jquery.pagination.js")"></script> 
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="@Url.Content("~/Content/MpMaterial/javascript/jquery.tmpl.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Content/MpMaterial/javascript/knockout.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Content/MpMaterial/javascript/knockout.mapping.js")"></script>
</head>
<body class="zh_CN ivrSettingPage">

    <div id="main" class="container">
        <div class="containerBox">
            <div class="boxHeader">
                <h2><span class="boxHeader_name"><a href="#">高级功能</a> &gt; 关键词回复</span></h2>
            </div>
            <div class="content">
                <div class="cLineB">
                    <h3 class="left">关键词自动回复<a class="FAQ" href="#">公众平台如何设置关键词自动回复？</a></h3>
                    <div id="Pagination" class="scott"></div>
                    <div class="clr"></div>
                </div>
                <div id="ivrSettingArea" class="settingArea">
                    <div class="float-p" style="margin: 10px 0;">
                        <button id="newRule" style="margin-right: 0;" data-bind="click:add" class="btnGrayS right">添加规则</button>
                    </div>
                    <ul id="listContainer" data-bind="foreach:mplist">
                        <li class="ruleItem" data-ruleid="21755">
                            <div class="title">
                                <div class="left">
                                    <h4><span class="b">规则<label data-bind="text:$index()+1"></label></span>&nbsp;<span class="n header" data-bind="text:RuleName"></span></h4>
                                </div>
                                <div class="right">
                                    <a class="unfold c-b" href="#">展开</a>
                                    <a class="pickup c-b" href="#">收起</a>
                                </div>
                                <div class="clr"></div>
                            </div>
                            <div class="settingPre">
                                <div class="preBox float-p">
                                    <label class="b">关键词：</label>
                                    <ul class="items keywordsPre">
                                        <li class="item" data-bind="text:KeywordName,attr:{title:KeywordName}"></li>
                                    </ul>
                                </div>
                                <div class="preBox float-p">
                                    <label class="b">回复：</label>
                                    <p class="items replyPre">
                                        <span class="replyCnt">1</span>条 （
                           <span class="wordsCnt">0</span>条文字，
                           <span class="appMsgCnt">0</span>条图文）
                                    </p>
                                </div>
                            </div>
                            <div class="detail float-p">
                                <div class="cLine ruleNameWrap">
                                    <label class="c-g9">
                                        规则名：
                                        <input data-bind="value:RuleName" class="txtInput ruleName" type="text"></label>
                                    <span class="c-g9" style="padding-left: 10px;">规则名最多60个字</span>
                                </div>
                                <div class="float-p">
                                    <div class="left keywordsList">
                                        <div class="cLine header"><span class="left b">关键字</span></div>
                                        <ul class="keywordItems">
                                            <li class="item float-p" data-kwid="0">
                                                <label class="left">
                                                    <input type="text" style="width: 200px" data-bind="value:KeywordName,attr:{title:KeywordName}" />
                                                </label>
                                            </li>
                                        </ul>
                                        <div class="btnArea float-p">
                                        </div>
                                    </div>
                                    <div class="replyList">
                                        <div class="cLine header">
                                            <p class="left b">回复</p>
                                            <label class="right">
                                                <input class="allReply" type="checkBox">发送全部回复</label>
                                        </div>
                                        <ul class="replyItems showWords showFile showAppMsg">
                                            <!-- ko if: $data.MpMaterial.TypeName()=="text" -->
                                            <li class="item float-p replyWords" data-rpid="0" data-type="1">
                                                <div class="contentWrap left">
                                                    <div class="wordContent" data-bind="text:$data.MpMaterial.MpMaterialItems()[0].ReplyContent"></div>
                                                </div>
                                            </li>
                                            <!-- /ko -->
                                            <!-- ko if: $data.MpMaterial.TypeName()=="news" -->
                                            <li class="item float-p replyWords" data-rpid="0" data-type="1">
                                                <div class="contentWrap left">
                                                    <div data-create-time="2013-05-15" data-appid="10000018" id="appmsg10000018" class="msg-item-wrapper">
                                                        <div class="msg-item multi-msg" data-bind="foreach:$data.MpMaterial.MpMaterialItems">
                                                            <!-- ko if: $index()==0 -->
                                                            <div class="appmsgItem" id="appmsgItem1">
                                                                <p class="msg-meta"><span class="msg-date">2013-05-15</span></p>
                                                                <div class="cover">
                                                                    <p style="display: none" class="default-tip">封面图片</p>
                                                                    <h4 class="msg-t"><a target="_blank" class="i-title" data-bind="text:Title"></a></h4>
                                                                    <img style="" class="i-img" data-bind="attr:{ src: '@(path)'+PicUrl()}">
                                                                </div>
                                                            </div>
                                                            <!-- /ko -->
                                                            <!-- ko if: $index()>0 -->
                                                            <div id="appmsgItem2" class="rel sub-msg-item appmsgItem">
                                                                <span class="thumb">
                                                                    <span style="display: none" class="default-tip">缩略图</span>
                                                                    <img style="" class="i-img" data-bind="attr:{ src: '@(path)'+PicUrl()}">
                                                                </span>
                                                                <h4 class="msg-t"><a class="i-title" data-bind="text:Title" href="#"></a></h4>
                                                            </div>
                                                            <!-- /ko -->
                                                        </div>
                                                        <div class="msg-hover-mask"></div>
                                                    </div>
                                                </div>
                                            </li>
                                            <!-- /ko -->
                                        </ul>
                                        <div class="btnArea float-p">
                                            <a href="#" class="right block" data-bind="click:$root.loadMaterial">
                                                <button class="addAppMsg btnAdd c-opr">图文</button></a>
                                            <a href="#" class="right block" data-bind="click:$root.selText">
                                                <button class="addWords btnAdd c-opr">文字</button></a>
                                        </div>
                                    </div>
                                </div>
                                <div class="btnArea float-p operator">
                                    <button data-bind="click:$root.del" class="delRule btnGrayS right">删除</button>
                                    <button data-bind="click:$root.save" class="saveRule right btnGreenS">保存</button>
                                </div>
                            </div>
                        </li>
                    </ul>

                </div>
            </div>
            <div class="clr"></div>
        </div>
    </div>
    <!--图文弹出层效果-->
    <div class="dialog_wrp media" data-bind="style: { display: showDialog() ? 'block' : 'none' }" style="width: 760px; margin-left: -380px; margin-top: -314.5px;">
        <div class="dialog" data-bind="style: { display: showTextDialog() ? 'none' : 'block' }">
            <div class="dialog_hd">
                <h3>选择素材</h3>
                <a href="#" data-bind="click: function () { showDialog(false) }" class="icon16_opr closed pop_closed">关闭</a>
            </div>
            <div class="dialog_bd">
                <div class="dialog_media_container" style="">
                    <div class="sub_title_bar in_dialog">
                        <div class="info">
                            <div class="appmsg_create">                                
                            </div>
                        </div>
                        <div class="pagination_wrp pageNavigator">
                            <div class="pagination" id="wxPagebar_1389075386801">
                                <span class="page_nav_area">
                                    <div id="Pagination1" style="height:30px;margin:0px;padding:0px;" class="scott"></div>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="js_appmsg_list appmsg_list media_dialog">
                        <div class="appmsg_col">
                            <div class="inner" id="first_col"></div>
                        </div>

                        <div class="appmsg_col">
                            <div class="inner" id="second_col"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dialog_ft">
                <span class="btn btn_primary btn_input js_btn_p" data-bind="click: selMaterial">
                    <button class="js_btn" data-index="0">确定</button></span>
                <span class="btn btn_default btn_input js_btn_p" data-bind="click: function () { showDialog(false) }">
                    <button class="js_btn" data-index="1">取消</button></span>
            </div>
        </div>
        <div class="dialog" data-bind="style: { display: showTextDialog() ? 'block' : 'none' }">
            <div class="dialog_hd">
                <h3>添加回复文字</h3>
                <a href="#" data-bind="click: function () { showDialog(false) }" class="icon16_opr closed pop_closed">关闭</a>
            </div>
            <div class="dialog_bd">
                <div class="js_textArea inner no_extra">
                    <div class="emotion_editor" style="padding: 50px;">
                        <input type="radio" id="userstae0" data-bind="checked:IsChat" name="userstate" value="0" /><label for="userstae0">正常文字回复</label>
                        <input type="radio" id="userstae1" data-bind="checked:IsChat" name="userstate" value="1" /><label for="userstae1">客服连接命令</label>
                        <input type="radio" id="userstae2" data-bind="checked:IsChat" name="userstate" value="2" /><label for="userstae2">客服断开命令</label>
                        <textarea style="width: 99%; height: 150px; margin: 0px;" id="divArea"></textarea>
                        <div class="editor_toolbar">
                            <a href="#" class="icon_emotion emotion_switch js_switch" style="display: none;">表情</a>
                            <p class="editor_tip js_editorTip"><em></em></p>
                            <div class="emotion_wrp js_emotionArea">
                                <span class="emotions_preview js_emotionPreviewArea">
                                    <img src="images/99.gif" /></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dialog_ft">
                <span class="btn btn_primary btn_input js_btn_p" data-bind="click: selMaterial">
                    <button class="js_btn" data-index="0">确定</button></span>
                <span class="btn btn_default btn_input js_btn_p" data-bind="click: function () { showDialog(false) }">
                    <button class="js_btn" data-index="1">取消</button></span>
            </div>
        </div>
    </div>
    <script id="mptmplfirst" type="text/x-jquery-tmpl">
        <div id="appmsg${$data.Id}">
            <div class="appmsg multi">
                <div class="appmsg_content">
                    <div class="appmsg_info">
                        <em class="appmsg_date">2013年06月07日</em>
                    </div>
                    {{each(j,item) $data.MpMaterialItems}}
                                                        {{if j==0}} 
                                                <div class="cover_appmsg_item">
                                                    <h4 class="appmsg_title"><a href="#">${item.Title}</a></h4>
                                                    <div class="appmsg_thumb_wrp">
                                                        <img src="@(path)${item.PicUrl}" alt="" class="appmsg_thumb">
                                                    </div>
                                                </div>
                    {{else}}
                                                        <div class="appmsg_item">
                                                            <img src="@(path)${item.PicUrl}" alt="" class="appmsg_thumb">
                                                            <h4 class="appmsg_title"><a href="#">${item.Title}</a></h4>
                                                        </div>
                    {{/if}}
                                                      {{/each}}  
                                                
                </div>
                <div class="appmsg_mask"></div>
                <i class="icon_appmsg_selected">已选择</i>
            </div>
        </div>
    </script>
    <script id="mptmplsecond" type="text/x-jquery-tmpl" id="second_col">
        <div id="appmsg${$data.Id}">
            <div class="appmsg multi">
                <div class="appmsg_content">
                    <div class="appmsg_info">
                        <em class="appmsg_date">2013年06月07日</em>
                    </div>
                    {{each(j,item) $data.MpMaterialItems}}
                                                        {{if j==0}} 
                                                <div class="cover_appmsg_item">
                                                    <h4 class="appmsg_title"><a href="#">${item.Title}</a></h4>
                                                    <div class="appmsg_thumb_wrp">
                                                        <img src="@(path)${item.PicUrl}" alt="" class="appmsg_thumb">
                                                    </div>
                                                </div>
                    {{else}}
                                                        <div class="appmsg_item">
                                                            <img src="@(path)${item.PicUrl}" alt="" class="appmsg_thumb">
                                                            <h4 class="appmsg_title"><a href="#">${item.Title}</a></h4>
                                                        </div>
                    {{/if}}
                                                      {{/each}}  
                                                
                </div>
                <div class="appmsg_mask"></div>
                <i class="icon_appmsg_selected">已选择</i>
            </div>
        </div>
    </script>
    <div class="mask" data-bind="style: { display: showDialog() ? 'block' : 'none' }"></div>
    <div class="mask" id="loading" style="display: none;"></div>
    <div class="JS_TIPS page_tips success" id="lbzLoding" style="display: none;">
        <div class="inner">保存成功</div>
    </div>
</body>
</html>
<script type="text/javascript">   
    var mplist = @Html.Raw(ViewBag.strList);
    var currmaterial = null;
    var currReply = null;
    function viewModel() {
        var self=this;
        var mapping = {
            'KeywordName': {
                update: function(options) {
                    return Komapping.hmDe(options.data);
                }
            },
            'RuleName': {
                update: function (options) {
                    return Komapping.hmDe(options.data);
                }
            },
            'ReplyContent': {
                update: function (options) {
                    return Komapping.hmDe(options.data);
                }
            }
        }
        self.mplist = ko.mapping.fromJS(mplist,mapping);
        self.reply=ko.observable(self.mplist()[0]);
        self.showDialog = ko.observable(false); 
        self.empty = ko.observable({ Id: "00000000-0000-0000-0000-000000000000", MpMaterialItems: [{ Id: "00000000-0000-0000-0000-000000000000",Title:"",Description:"",PicUrl:"", ReplyContent: "" }], TypeName: "text",IsChat:0 });

        self.showTextDialog = ko.observable(true);   
        self.IsChat=ko.observable("0");
        self.cMaterial=ko.observable(self.empty);
        self.selText=function(item){
            self.reply(item);
            self.showDialog(true);
            self.showTextDialog(true);
            if(item.MpMaterial.TypeName()=="news"){
                currmaterial=self.empty();
                self.IsChat("0");
                $("#divArea").val("");
                self.cMaterial(currmaterial);               
            }else {
                $("#divArea").val(item.MpMaterial.MpMaterialItems()[0].ReplyContent());
                self.IsChat(item.MpMaterial.IsChat().toString());                
                currmaterial=ko.toJS(item.MpMaterial);
                self.cMaterial(item.MpMaterial);
            }
        };
        self.selMaterial = function () {
            if (currmaterial != null) {   
                currmaterial.MpMaterialItems[0].ReplyContent=$("#divArea").val(); 
                currmaterial.IsChat=self.IsChat();
                if (currmaterial.TypeName=="text"&&$("#divArea").val().length==0) {
                    alert("文字必须为1到300个字");
                    return false;
                }
                self.cMaterial(currmaterial);                
                ko.mapping.fromJS(self.cMaterial(), {}, self.reply().MpMaterial);                  
                self.showDialog(false);                
            }
        };
        self.loadMaterial = function (item) {
            currmaterial=null;
            self.reply(item);
            self.showDialog(true);            
            self.showTextDialog(false);
            $.ajax({
                url: "/MpMaterial/GetMaterialData?t=" + Math.random(),
                type: "post",
                data: {},
                dataType: "json",
                success: function (json) {
                    if (json.success) {
                        var mpitems = JSON.parse(json.message);
                        var firstitems = $.grep(mpitems, function (i, value) {
                            return value % 2 == 0;
                        });
                        var seconditems = $.grep(mpitems, function (i, value) {
                            return value % 2 == 1;
                        });
                        $("#first_col").html("");
                        $("#second_col").html("");
                        $("#mptmplfirst").tmpl(firstitems).appendTo('#first_col');
                        $("#mptmplsecond").tmpl(seconditems).appendTo('#second_col');
                    } else {
                        alert('提交数据失败');
                    }
                }
            })
        };
        self.save = function (item) {           
            if (item.RuleName().length==0) {
                alert('规则名不能为空');
                return;
            }
            if (item.KeywordName().length==0) {
                alert('至少输入一个关键词');
                return;
            }
            if (item.MpMaterial==null) {
                alert('至少设置一个回复');
                return;
            }           

            $.ajax({
                url: "/MpReply/SaveReply",
                type: "post",
                data: { data: ko.mapping.toJSON(item) },
                dataType: "json",
                success: function (json) {
                    if (json.success) {
                        window.location.reload();
                    } else {
                        alert('提交数据失败');
                    }
                }
            })

        };
        self.add=function(){
            var b=false;
            $.each(self.mplist(),function(){
                if (this.Id()=="00000000-0000-0000-0000-000000000000") {
                    b=true;                  
                    return false;
                }
            });
            if (b) {
                self.mplist.shift();
                return;
            }
            self.mplist.unshift(ko.mapping.fromJS({"MpMaterial":{"IsChat":0,"MpMaterialItems":[{"MaterialID":"00000000-0000-0000-0000-000000000000","ReplyContent":"","Title":"","PicUrl":""}],"TypeName":"text","Id":"00000000-0000-0000-0000-000000000000"},
                "RuleName":"","KeywordName":"","Action":"smartreply","MatchMode":0,"MaterialID":"00000000-0000-0000-0000-000000000000","Id":"00000000-0000-0000-0000-000000000000"}));
            $("#listContainer>li:first").addClass("ruleItemEditing");            
        };
        self.del = function (item) {
            if (confirm("确定要删除规则吗？")) {
                $.ajax({
                    url: "/MpReply/DelReply",
                    type: "post",
                    data: { id: item.Id() },
                    dataType: "json",
                    success: function (json) {
                        if (json.success) {
                            window.location.reload();
                        } else {
                            alert('提交数据失败');
                        }
                    }
                });
            }
            
        };
    }
    ko.applyBindings(new viewModel());
    $('#first_col').delegate('.appmsg', 'click', function () {
        $(".appmsg").removeClass("selected");
        $(this).addClass("selected");
        currmaterial = $.tmplItem(this).data;        
    });
    $('#second_col').delegate('.appmsg', 'click', function () {
        $(".appmsg").removeClass("selected");
        $(this).addClass("selected");
        currmaterial = $.tmplItem(this).data;
    });
    $(function(){
        function pageselectCallback(page_id, jq) {
            //回调函数，进一步使用请参阅说明文档
            return true;
        }
        function pageselectAjax(page_id, jq) {
            //回调函数，进一步使用请参阅说明文档
            return false;
        }
        $("#Pagination").pagination(@(ViewBag.totalCount), {          
            callback: pageselectCallback,
            prev_text: " 上一页",
            next_text: "下一页 ",
            items_per_page: 10, //每页的数据个数
            num_display_entries: 5, //两侧首尾分页条目数
            current_page: @pageid,   //当前页码
            num_edge_entries: 3, //连续分页主体部分分页条目数
            link_to:"?page=__id__"
        });
        @*$("#Pagination1").pagination(@(ViewBag.totalCount), {          
            callback: pageselectAjax,
            prev_text: " 上一页",
            next_text: "下一页 ",
            items_per_page: 10, //每页的数据个数
            num_display_entries: 5, //两侧首尾分页条目数
            current_page: @pageid,   //当前页码
            num_edge_entries: 3, //连续分页主体部分分页条目数
            link_to:"?page=__id__"
        });*@
        $(".title").live("click",function(){
            if ($(this).parent().hasClass("ruleItemEditing")) {
                $(this).parent().removeClass("ruleItemEditing");
            }else{
                $(this).parent().addClass("ruleItemEditing");
            }
        });
        $("#userstae1").click(function(){
            $("#divArea").val("连接客服成功，聊天请继续；如果想退出聊天可以输入“您自定义的”命令。");
        });
        $("#userstae0").click(function(){
            $("#divArea").val("");
        });
        $("#userstae2").click(function(){
            $("#divArea").val("成功退出聊天，若想再次咨询我，记得发送“您自定义的”命令。");
        });
        $(document).ajaxStart(function(){
            $("#lbzLoding>.inner").html("数据处理中");
            $("#loading").show();
            $("#lbzLoding").show();
        }).ajaxSuccess(function(){
            $("#lbzLoding>.inner").html("操作成功");
            $("#loading").hide();
            $("#lbzLoding").hide(300);
        }).ajaxError(function(){
            $("#loading").hide();
            $("#lbzLoding").hide();
            alert("数据执行不成功");
        });
    });
</script>
